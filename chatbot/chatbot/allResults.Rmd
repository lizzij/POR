---
title: "Survey Data Investigation"
author: "Eliza"
date: "5/14/2019"
output:
  html_document:
    df_print: paged
---

### Conclusion
Cause of duplicates:

- going back to previous day/pages (already disabled)
- submit, then refresh → form submitted again upon refreshing

### Purpose
To investigate the cases where there is:  

- duplicated survey answers or 
- missing survey answers

```{r setup, include=TRUE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr) 
library(tidyverse)
```

### 1. Import data
```{r import}
all_results <- read.csv("allResults.csv", header = F, sep = ",")
names(all_results) <- c("user_id", "day", "question", "answer", "timestamp")

head(all_results)
```

### 2. Clean up
Tidy up user_id:

- User ID mapping from old to new convention
- Remove irrelevant users
```{r clean}
print("previous user_ids")
all_users <- all_results$user_id %>% unique()
all_users

# remove user 1 to 5
all_results <- all_results %>% filter(all_results$user_id > 5)

# rename to new user_id
all_results$user_id[all_results$user_id == 112] <- 2884055
all_results$user_id[all_results$user_id == 111] <- 3780005
all_results$user_id[all_results$user_id == 110] <- 4125240
all_results$user_id[all_results$user_id == 109] <- 5338852
all_results$user_id[all_results$user_id == 108] <- 6467910
all_results$user_id[all_results$user_id == 107] <- 8194629
all_results$user_id[all_results$user_id == 106] <- 9331127
all_results$user_id[all_results$user_id == 105] <- 10960925
all_results$user_id[all_results$user_id == 104] <- 11459752 

print("updated user_ids")
all_users_updated <- all_results$user_id %>% unique()
all_users_updated
```

### 3. Get duplicates
Count number of entries by day, extract duplicates
```{r count}
# more than one entry 
duplicates <- all_results %>% 
  select(user_id, day, question) %>%
  group_by_all() %>% 
  summarise(count = n()) %>% 
  filter(count > 1)

duplicates <- merge(duplicates, all_results)
number_of_dup <- nrow(duplicates)
cat("Total number of duplicates:", number_of_dup)
```

### 4. Analyze duplicates
```{r duplicates}
# remove expected duplicates

# day 6 recallWhichAirQualitySource 
duplicates <- duplicates %>% filter(!(day==6 & question=="recallWhichAirQualitySource"))

# day 7 whoToldMe 
duplicates <- duplicates %>% filter(!(day==7 & question=="whoToldMe"))

# user 1882385 (Eliza testing)
duplicates <- duplicates %>% filter(!(user_id==1882385))

duplicates <- duplicates %>% 
  arrange(day, user_id)
  
duplicates

# Category 1: same day, same question, different answer
duplicates_diff_ans <- duplicates %>% slice(72:73)
duplicates_diff_ans

# Category 2: same day, same question, same answer
duplicates_same_ans <- duplicates %>% slice(42:43)
duplicates_same_ans
```

### 5. Hypothesis
There are 2 categories of duplicates

- Category 1: same day, same question, different answer
  - before "no access to previous surveys" was enfored (solved)
- Category 2: same day, same question, same answer
  - refreshing page after submitting → multiple submissions
  - same timestamp to minutes, should be difference in seconds (see the test below with current result data)

### 6. Test
Test hypothesis with more detailed timestamps
```{r time}
# allResultsTime.csv contains more detailed timestamps (after changing templates)
all_results_time <- read.csv("allResultsTime.csv", header = F, sep = ",")
names(all_results_time) <- c("user_id", "day", "question", "answer", "timestamp")

# remove user 1 to 5
all_results_time <- all_results_time %>% filter(all_results_time$user_id > 5)

# more than one entry 
duplicates_time <- all_results_time %>% 
  select(user_id, day, question) %>%
  group_by_all() %>% 
  summarise(count = n()) %>% 
  filter(count > 1)

duplicates_time <- merge(duplicates_time, all_results_time)

# remove expected duplicates

# day 6 recallWhichAirQualitySource 
duplicates_time <- duplicates_time %>% filter(!(day==6 & question=="recallWhichAirQualitySource"))

# day 7 whoToldMe 
duplicates_time <- duplicates_time %>% filter(!(day==7 & question=="whoToldMe"))

# user 1882385 (Eliza testing)
duplicates_time <- duplicates_time %>% filter(!(user_id==1882385))

duplicates_time <- duplicates_time %>% 
  arrange(day, user_id)

duplicates_time

# Category 1: same day, same question, different answer, different time-stamp (to seconds)
print("Does not exist: no access to previous survey.")

# Category 2: same day, same question, same answer, different time-stamp (to seconds)
duplicates_time_same_ans <- duplicates %>% slice(43:48)
duplicates_time_same_ans
```

### 6. Demo
Steps:  
1. Run flask locally, post user 1 activity to day 1  
2. Refresh after submitting user 1 day 1 page 1  

Results (<span style="color:green">submit time</span>, <span style="color:red">refresh time</span>):  

- allResults:  
  1,1,eventName,option2,2019-05-15 <span style="color:green">04:41:20.550263</span>  
  1,1,signUpFee,50,2019-05-15 <span style="color:green">04:41:20.550263</span>  
  1,1,eventName,option2,2019-05-15 <span style="color:red">04:41:38.888190</span>  
  1,1,signUpFee,50,2019-05-15 <span style="color:red">04:41:38.888190</span>  
  
- allActivities:  
  1,1,0,2,2019-05-15 04:40:47.719237,2019-05-15 <span style="color:red">04:41:38.888190</span>  














[End]